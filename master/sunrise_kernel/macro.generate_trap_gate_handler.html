<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="API documentation for the Rust `generate_trap_gate_handler` macro in crate `sunrise_kernel`."><meta name="keywords" content="rust, rustlang, rust-lang, generate_trap_gate_handler"><title>sunrise_kernel::generate_trap_gate_handler - Rust</title><link rel="stylesheet" type="text/css" href="../normalize.css"><link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" type="text/css" href="../dark.css"><link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle"><script src="../storage.js"></script><noscript><link rel="stylesheet" href="../noscript.css"></noscript><link rel="shortcut icon" href="../favicon.ico"><style type="text/css">#crate-search{background-image:url("../down-arrow.svg");}</style></head><body class="rustdoc macro"><!--[if lte IE 8]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="sidebar"><div class="sidebar-menu">&#9776;</div><a href='../sunrise_kernel/index.html'><div class='logo-container'><img src='../rust-logo.png' alt='logo'></div></a><div class="sidebar-elems"><p class='location'><a href='index.html'>sunrise_kernel</a></p><script>window.sidebarCurrent = {name: 'generate_trap_gate_handler', ty: 'macro', relpath: ''};</script><script defer src="sidebar-items.js"></script></div></nav><div class="theme-picker"><button id="theme-picker" aria-label="Pick another theme!"><img src="../brush.svg" width="18" alt="Pick another theme!"></button><div id="theme-choices"></div></div><script src="../theme.js"></script><nav class="sub"><form class="search-form"><div class="search-container"><div><select id="crate-search"><option value="All crates">All crates</option></select><input class="search-input" name="search" disabled autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"></div><a id="settings-menu" href="../settings.html"><img src="../wheel.svg" width="18" alt="Change settings"></a></div></form></nav><section id="main" class="content"><h1 class='fqn'><span class='out-of-band'><span id='render-detail'><a id="toggle-all-docs" href="javascript:void(0)" title="collapse all docs">[<span class='inner'>&#x2212;</span>]</a></span><a class='srclink' href='../src/sunrise_kernel/i386/interrupt_service_routines.rs.html#420-603' title='goto source code'>[src]</a></span><span class='in-band'>Macro <a href='index.html'>sunrise_kernel</a>::<wbr><a class="macro" href=''>generate_trap_gate_handler</a></span></h1><div class="docblock type-decl hidden-by-usual-hider"><div class="example-wrap"><pre class="rust macro">
<span class="macro">macro_rules</span><span class="macro">!</span> <span class="ident">generate_trap_gate_handler</span> {
    (<span class="ident">__gen</span> <span class="ident">kernel_fault</span>; <span class="ident">name</span>: <span class="macro-nonterminal">$</span><span class="macro-nonterminal">exception_name</span>:<span class="ident">literal</span>, <span class="macro-nonterminal">$</span><span class="macro-nonterminal">hwcontext</span>:<span class="ident">ident</span>, <span class="ident">errcode</span>: <span class="bool-val">true</span>, <span class="ident">strategy</span>: <span class="ident">panic</span>) <span class="op">=</span><span class="op">&gt;</span> { ... };
    (<span class="ident">__gen</span> <span class="ident">kernel_fault</span>; <span class="ident">name</span>: <span class="macro-nonterminal">$</span><span class="macro-nonterminal">exception_name</span>:<span class="ident">literal</span>, <span class="macro-nonterminal">$</span><span class="macro-nonterminal">hwcontext</span>:<span class="ident">ident</span>, <span class="ident">errcode</span>: <span class="bool-val">false</span>, <span class="ident">strategy</span>: <span class="ident">panic</span>) <span class="op">=</span><span class="op">&gt;</span> { ... };
    (<span class="ident">__gen</span> <span class="ident">user_fault</span>; <span class="ident">name</span>: <span class="macro-nonterminal">$</span><span class="macro-nonterminal">exception_name</span>:<span class="ident">literal</span>, <span class="macro-nonterminal">$</span><span class="macro-nonterminal">hwcontext</span>:<span class="ident">ident</span>, <span class="ident">errcode</span>: <span class="bool-val">true</span>, <span class="ident">strategy</span>: <span class="ident">panic</span>) <span class="op">=</span><span class="op">&gt;</span> { ... };
    (<span class="ident">__gen</span> <span class="ident">user_fault</span>; <span class="ident">name</span>: <span class="macro-nonterminal">$</span><span class="macro-nonterminal">exception_name</span>:<span class="ident">literal</span>, <span class="macro-nonterminal">$</span><span class="macro-nonterminal">hwcontext</span>:<span class="ident">ident</span>, <span class="ident">errcode</span>: <span class="bool-val">false</span>, <span class="ident">strategy</span>: <span class="ident">panic</span>) <span class="op">=</span><span class="op">&gt;</span> { ... };
    (<span class="ident">__gen</span> <span class="ident">handler</span>; <span class="ident">name</span>: <span class="macro-nonterminal">$</span><span class="macro-nonterminal">exception_name</span>:<span class="ident">literal</span>, <span class="macro-nonterminal">$</span><span class="macro-nonterminal">hwcontext</span>:<span class="ident">ident</span>, <span class="ident">errcode</span>: <span class="bool-val">true</span>, <span class="ident">strategy</span>: <span class="ident">panic</span>) <span class="op">=</span><span class="op">&gt;</span> { ... };
    (<span class="ident">__gen</span> <span class="ident">handler</span>; <span class="ident">name</span>: <span class="macro-nonterminal">$</span><span class="macro-nonterminal">exception_name</span>:<span class="ident">literal</span>, <span class="macro-nonterminal">$</span><span class="macro-nonterminal">hwcontext</span>:<span class="ident">ident</span>, <span class="ident">errcode</span>: <span class="bool-val">false</span>, <span class="ident">strategy</span>: <span class="ident">panic</span>) <span class="op">=</span><span class="op">&gt;</span> { ... };
    (<span class="ident">__gen</span> <span class="ident">handler</span>; <span class="ident">name</span>: <span class="macro-nonterminal">$</span><span class="macro-nonterminal">exception_name</span>:<span class="ident">literal</span>, <span class="macro-nonterminal">$</span><span class="macro-nonterminal">hwcontext</span>:<span class="ident">ident</span>, <span class="ident">errcode</span>: <span class="bool-val">true</span>, <span class="ident">strategy</span>: <span class="ident">kill</span>) <span class="op">=</span><span class="op">&gt;</span> { ... };
    (<span class="ident">__gen</span> <span class="ident">handler</span>; <span class="ident">name</span>: <span class="macro-nonterminal">$</span><span class="macro-nonterminal">exception_name</span>:<span class="ident">literal</span>, <span class="macro-nonterminal">$</span><span class="macro-nonterminal">hwcontext</span>:<span class="ident">ident</span>, <span class="ident">errcode</span>: <span class="bool-val">false</span>, <span class="ident">strategy</span>: <span class="ident">kill</span>) <span class="op">=</span><span class="op">&gt;</span> { ... };
    (<span class="ident">__gen</span> <span class="macro-nonterminal">$</span><span class="macro-nonterminal">_all</span>:<span class="ident">ident</span>; <span class="ident">name</span>: <span class="macro-nonterminal">$</span><span class="macro-nonterminal">_exception_name</span>:<span class="ident">literal</span>, <span class="macro-nonterminal">$</span><span class="macro-nonterminal">_hwcontext</span>:<span class="ident">ident</span>, <span class="ident">errcode</span>: <span class="macro-nonterminal">$</span><span class="macro-nonterminal">_errcode</span>:<span class="ident">ident</span>, <span class="ident">strategy</span>: <span class="ident">ignore</span>) <span class="op">=</span><span class="op">&gt;</span> { ... };
    (<span class="ident">__gen</span> <span class="macro-nonterminal">$</span><span class="macro-nonterminal">_all</span>:<span class="ident">ident</span>; <span class="ident">name</span>: <span class="macro-nonterminal">$</span><span class="macro-nonterminal">exception_name</span>:<span class="ident">literal</span>, <span class="macro-nonterminal">$</span><span class="macro-nonterminal">hwcontext</span>:<span class="ident">ident</span>, <span class="ident">errcode</span>: <span class="macro-nonterminal">$</span><span class="macro-nonterminal">errcode</span>:<span class="ident">ident</span>, <span class="ident">strategy</span>: <span class="macro-nonterminal">$</span><span class="macro-nonterminal">fnname</span>:<span class="ident">ident</span>) <span class="op">=</span><span class="op">&gt;</span> { ... };
    (<span class="ident">__gen</span> <span class="ident">asm_wrapper</span>; <span class="macro-nonterminal">$</span><span class="macro-nonterminal">wrapper_asm_fnname</span>:<span class="ident">ident</span>, <span class="macro-nonterminal">$</span><span class="macro-nonterminal">wrapper_rust_fnname</span>:<span class="ident">ident</span>, <span class="macro-nonterminal">$</span><span class="macro-nonterminal">errcode</span>:<span class="ident">ident</span>) <span class="op">=</span><span class="op">&gt;</span> { ... };
    (
    <span class="ident">name</span>: <span class="macro-nonterminal">$</span><span class="macro-nonterminal">exception_name</span>:<span class="ident">literal</span>,
    <span class="ident">has_errcode</span>: <span class="macro-nonterminal">$</span><span class="macro-nonterminal">has_errcode</span>:<span class="ident">ident</span>,
    <span class="ident">wrapper_asm_fnname</span>: <span class="macro-nonterminal">$</span><span class="macro-nonterminal">wrapper_asm_fnname</span>:<span class="ident">ident</span>,
    <span class="ident">wrapper_rust_fnname</span>: <span class="macro-nonterminal">$</span><span class="macro-nonterminal">wrapper_rust_fnname</span>:<span class="ident">ident</span>,
    <span class="ident">kernel_fault_strategy</span>: <span class="macro-nonterminal">$</span><span class="macro-nonterminal">kernel_fault_strategy</span>:<span class="ident">ident</span>,
    <span class="ident">user_fault_strategy</span>: <span class="macro-nonterminal">$</span><span class="macro-nonterminal">user_fault_strategy</span>:<span class="ident">ident</span>,
    <span class="ident">handler_strategy</span>: <span class="macro-nonterminal">$</span><span class="macro-nonterminal">handler_strategy</span>:<span class="ident">ident</span>
    ) <span class="op">=</span><span class="op">&gt;</span> { ... };
    (
    <span class="ident">name</span>: <span class="macro-nonterminal">$</span><span class="macro-nonterminal">exception_name</span>:<span class="ident">literal</span>,
    <span class="ident">has_errcode</span>: <span class="macro-nonterminal">$</span><span class="macro-nonterminal">has_errcode</span>:<span class="ident">ident</span>,
    <span class="ident">wrapper_asm_fnname</span>: <span class="macro-nonterminal">$</span><span class="macro-nonterminal">wrapper_asm_fnname</span>:<span class="ident">ident</span>,
    <span class="ident">wrapper_rust_fnname</span>: <span class="macro-nonterminal">$</span><span class="macro-nonterminal">wrapper_rust_fnname</span>:<span class="ident">ident</span>,
    <span class="ident">kernel_fault_strategy</span>: <span class="macro-nonterminal">$</span><span class="macro-nonterminal">kernel_fault_strategy</span>:<span class="ident">ident</span>,
    <span class="ident">user_fault_strategy</span>: <span class="macro-nonterminal">$</span><span class="macro-nonterminal">user_fault_strategy</span>:<span class="ident">ident</span>,
    <span class="ident">handler_strategy</span>: <span class="macro-nonterminal">$</span><span class="macro-nonterminal">handler_strategy</span>:<span class="ident">ident</span>,
    <span class="ident">interrupt_context</span>: <span class="macro-nonterminal">$</span><span class="macro-nonterminal">interrupt_context</span>:<span class="ident">literal</span>
    ) <span class="op">=</span><span class="op">&gt;</span> { ... };
}</pre></div>
</div><div class='docblock'><p>Generates a trap/interrupt gate isr.</p>
<h1 id="goal" class="section-header"><a href="#goal">Goal</a></h1>
<p>This macro generates a handler for a trap/interrupt gate that will:</p>
<ol>
<li>save userspace hardware context in the <a href="../sunrise_kernel/process/struct.ThreadStruct.html">ThreadStruct</a></li>
<li>check boilerplate conditions like if the kernel generated the instruction, or if &quot;panic-on-exception&quot; is on.</li>
<li>call a function to handle the interrupt</li>
<li>check if the current process was killed, in which case unschedule instead ourselves of returning</li>
<li>restore the userspace context</li>
<li><code>iret</code></li>
</ol>
<p>This macro is designed to be modular, the idea being that every exception does pretty much the same thing,
but in a slightly different way. Because of this we want the step 2 and 3 to be parameterizable.</p>
<p>The way we do this is defining a few standard strategies for step 2 and 3, letting the user choose
which one it wants, and also letting the user override those strategies if they do not fit its use case.</p>
<p>The macro uses <a href="../sunrise_kernel/macro.trap_gate_asm.html" title="`trap_gate_asm`"><code>trap_gate_asm</code></a> as a the low-level asm handler.</p>
<h1 id="usage" class="section-header"><a href="#usage">Usage</a></h1>
<p>You are expected to use this macro in the following way:</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="macro">generate_trap_gate_handler</span><span class="macro">!</span>(<span class="ident">name</span>: <span class="string">&quot;BOUND Range Exceeded Exception&quot;</span>,                 <span class="comment">// name of this interrupt, used for logging and when panicking.</span>
               <span class="ident">has_errcode</span>: <span class="bool-val">false</span>,                                                  <span class="comment">// whether the cpu pushes an error code on the stack for this interrupt.</span>
               <span class="ident">wrapper_asm_fnname</span>: <span class="ident">bound_range_exceeded_exception_asm_wrapper</span>,      <span class="comment">// name for the raw asm function this macro will generate. You can then put this function&#39;s address in the IDT.</span>
               <span class="ident">wrapper_rust_fnname</span>: <span class="ident">bound_range_exceeded_exception_rust_wrapper</span>,    <span class="comment">// name for the high-level rust handler this macro will generate.</span>
               <span class="ident">kernel_fault_strategy</span>: <span class="ident">panic</span>,                                        <span class="comment">// what to do if we were in kernelspace when this interruption happened.</span>
               <span class="ident">user_fault_strategy</span>: <span class="ident">panic</span>,                                          <span class="comment">// what to do if we were in userspace when this interruption happened, and feature &quot;panic-on-exception&quot; is enabled.</span>
               <span class="ident">handler_strategy</span>: <span class="ident">kill</span>,                                              <span class="comment">// what to for this interrupt otherwise</span>
               <span class="ident">interrupt_context</span>: <span class="bool-val">false</span>                                             <span class="comment">// OPTIONAL: basically: are IRQs disabled. False by default, true used for IRQs.</span>
);</pre></div>
<ul>
<li>The possible values for <code>kernel_fault_strategy</code> and <code>user_fault_strategy</code> are:
<ul>
<li><code>panic</code>: causes a kernel panic.</li>
<li><code>ignore</code>: don't do anything for this condition.</li>
<li><code>my_handler_func</code>: calls <code>my_handler_func</code> to handle this condition. Useful if you want to override a standard strategy.</li>
</ul>
</li>
<li>The possible values for <code>handler_strategy</code> are:
<ul>
<li><code>panic</code>: causes a kernel panic.</li>
<li><code>ignore</code>: don't do anything for this interrupt.</li>
<li><code>kill</code>: kills the process in which this interrupt originated.</li>
<li><code>my_handler_func</code>: calls <code>my_handler_func</code> to handle this interrupt. Useful if you want to override a standard strategy.</li>
</ul>
</li>
</ul>
<p>When providing a custom function as strategy, the function must be of signature:</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="kw">fn</span> <span class="ident">my_handler_func</span>(<span class="ident">exception_name</span>: <span class="kw-2">&amp;</span><span class="lifetime">&#39;static</span> <span class="ident">str</span>, <span class="ident">hwcontext</span>: <span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">UserspaceHardwareContext</span>, <span class="ident">has_errcode</span>: <span class="ident">bool</span>)</pre></div>
<p>The <a href="../sunrise_kernel/i386/interrupt_service_routines/struct.UserspaceHardwareContext.html">UserspaceHardwareContext</a> saved by the wrapper is passed by mut reference so the handler can modify it.
Those modifications will be effective as soon as we <code>iret</code>.</p>
<h1 id="generates" class="section-header"><a href="#generates">Generates</a></h1>
<p>This will generate some code along the lines of:</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="attribute">#[<span class="ident">naked</span>]</span>
<span class="kw">extern</span> <span class="string">&quot;C&quot;</span> <span class="kw">fn</span> <span class="macro-nonterminal">$</span><span class="macro-nonterminal">wrapper_asm_fnname</span>() {
    <span class="kw">unsafe</span> {
        <span class="macro">llvm_asm</span><span class="macro">!</span>(<span class="macro">interrupt_gate_llvm_asm</span><span class="macro">!</span>(<span class="ident">has_errorcode</span>: <span class="macro-nonterminal">$</span><span class="macro-nonterminal">has_errcode</span>)
        :: <span class="string">&quot;s&quot;</span>(<span class="macro-nonterminal">$</span><span class="macro-nonterminal">wrapper_rust_fnname</span> <span class="kw">as</span> <span class="kw">extern</span> <span class="string">&quot;C&quot;</span> <span class="kw">fn</span> (<span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">UserspaceHardwareContext</span>) : <span class="string">&quot;memory&quot;</span> : <span class="string">&quot;volatile&quot;</span>, <span class="string">&quot;intel&quot;</span>);
    }
}

<span class="kw">extern</span> <span class="string">&quot;C&quot;</span> <span class="kw">fn</span> <span class="macro-nonterminal">$</span><span class="macro-nonterminal">wrapper_rust_fnname</span>(<span class="ident">userspace_context</span>: <span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">UserspaceHardwareContext</span>) {

    <span class="kw">if</span> <span class="ident">coming</span> <span class="ident">from</span> <span class="ident">Ring</span> <span class="op">=</span><span class="op">=</span> <span class="number">0</span> {

        <span class="ident">kernel_panic</span>(<span class="kw-2">&amp;</span><span class="ident">PanicOrigin</span>::<span class="ident">KernelFault</span> {                                 <span class="comment">//</span>
            <span class="ident">exception_message</span>: <span class="macro">format_args</span><span class="macro">!</span>(<span class="string">&quot;{}, exception errcode: {:?}&quot;</span>,       <span class="comment">//</span>
                <span class="macro-nonterminal">$</span><span class="macro-nonterminal">exception_name</span>,                                                 <span class="comment">// kernel_fault_strategy</span>
                <span class="ident">userspace_context</span>.<span class="ident">errcode</span>),                                      <span class="comment">// (here: panic)</span>
            <span class="ident">kernel_hardware_context</span>: <span class="ident">userspace_context</span>.<span class="ident">clone</span>()                   <span class="comment">//</span>
        });                                                                      <span class="comment">//</span>

    } <span class="kw">else</span> {

        <span class="comment">// we come from userspace, backup the hardware context in the thread struct</span>
        {
            <span class="kw-2">*</span><span class="ident">get_current_thread</span>().<span class="ident">userspace_hwcontext</span>.<span class="ident">lock</span>() <span class="op">=</span> <span class="kw-2">*</span><span class="ident">userspace_context</span>
        }

        <span class="kw">if</span> <span class="macro">cfg</span><span class="macro">!</span>(<span class="ident">feature</span> <span class="op">=</span> <span class="string">&quot;panic-on-exception&quot;</span>) {

            <span class="ident">kernel_panic</span>(<span class="kw-2">&amp;</span><span class="ident">PanicOrigin</span>::<span class="ident">UserspaceFault</span> {                          <span class="comment">//</span>
                <span class="ident">exception_message</span>: <span class="ident">format_args</span> <span class="op">!</span> (<span class="string">&quot;{}, exception errcode: {:?}&quot;</span>, <span class="comment">//</span>
                    <span class="macro-nonterminal">$</span><span class="macro-nonterminal">exception_name</span>,                                             <span class="comment">// user_fault_strategy</span>
                    <span class="ident">userspace_context</span>.<span class="ident">errcode</span>),                                  <span class="comment">// (here: panic)</span>
                <span class="ident">userspace_hardware_context</span>: <span class="ident">userspace_context</span>.<span class="ident">clone</span>()            <span class="comment">//</span>
            });                                                                  <span class="comment">//</span>
        }

    }

    <span class="comment">// do the handler</span>
    {
        <span class="kw">let</span> <span class="ident">thread</span> <span class="op">=</span> <span class="ident">get_current_thread</span>();                                       <span class="comment">//</span>
        <span class="macro">error</span><span class="macro">!</span>(<span class="string">&quot;{}, errorcode: {}, in {:#?}&quot;</span>,                                    <span class="comment">// handler_strategy</span>
            <span class="macro-nonterminal">$</span><span class="macro-nonterminal">exception_name</span>, <span class="macro-nonterminal">$</span><span class="macro-nonterminal">hwcontext</span>.<span class="ident">errcode</span>, <span class="ident">thread</span>);                        <span class="comment">// (here: kill)</span>
        <span class="ident">ProcessStruct</span>::<span class="ident">kill_current_process</span>();                                   <span class="comment">//</span>
    }

    <span class="comment">// if we&#39;re returning to userspace, check we haven&#39;t been killed</span>
    <span class="kw">if</span> <span class="ident">comming</span> <span class="ident">from</span> <span class="ident">Ring</span> <span class="op">=</span><span class="op">=</span> <span class="number">3</span> {
        <span class="ident">check_thread_killed</span>();
    }
}</pre></div>
</div></section><section id="search" class="content hidden"></section><section class="footer"></section><script>window.rootPath = "../";window.currentCrate = "sunrise_kernel";</script><script src="../main.js"></script><script defer src="../search-index.js"></script></body></html>