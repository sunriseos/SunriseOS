<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="API documentation for the Rust `threads` mod in crate `sunrise_libuser`."><meta name="keywords" content="rust, rustlang, rust-lang, threads"><title>sunrise_libuser::threads - Rust</title><link rel="stylesheet" type="text/css" href="../../normalize.css"><link rel="stylesheet" type="text/css" href="../../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" type="text/css" href="../../dark.css"><link rel="stylesheet" type="text/css" href="../../light.css" id="themeStyle"><script src="../../storage.js"></script><noscript><link rel="stylesheet" href="../../noscript.css"></noscript><link rel="shortcut icon" href="../../favicon.ico"><style type="text/css">#crate-search{background-image:url("../../down-arrow.svg");}</style></head><body class="rustdoc mod"><!--[if lte IE 8]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="sidebar"><div class="sidebar-menu">&#9776;</div><a href='../../sunrise_libuser/index.html'><div class='logo-container'><img src='../../rust-logo.png' alt='logo'></div></a><p class='location'>Module threads</p><div class="sidebar-elems"><div class="block items"><ul><li><a href="#structs">Structs</a></li><li><a href="#constants">Constants</a></li><li><a href="#statics">Statics</a></li><li><a href="#functions">Functions</a></li></ul></div><p class='location'><a href='../index.html'>sunrise_libuser</a></p><script>window.sidebarCurrent = {name: 'threads', ty: 'mod', relpath: '../'};</script><script defer src="../sidebar-items.js"></script></div></nav><div class="theme-picker"><button id="theme-picker" aria-label="Pick another theme!"><img src="../../brush.svg" width="18" alt="Pick another theme!"></button><div id="theme-choices"></div></div><script src="../../theme.js"></script><nav class="sub"><form class="search-form"><div class="search-container"><div><select id="crate-search"><option value="All crates">All crates</option></select><input class="search-input" name="search" disabled autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"></div><a id="settings-menu" href="../../settings.html"><img src="../../wheel.svg" width="18" alt="Change settings"></a></div></form></nav><section id="main" class="content"><h1 class='fqn'><span class='out-of-band'><span id='render-detail'><a id="toggle-all-docs" href="javascript:void(0)" title="collapse all docs">[<span class='inner'>&#x2212;</span>]</a></span><a class='srclink' href='../../src/sunrise_libuser/threads.rs.html#1-405' title='goto source code'>[src]</a></span><span class='in-band'>Module <a href='../index.html'>sunrise_libuser</a>::<wbr><a class="mod" href=''>threads</a></span></h1><div class='docblock'><p>Low-level api to create threads and start them.</p>
<p>This module defines the low-level representation of a thread, kind to pthread on Unix.
You will want to abstract it in the libstd.</p>
<h1 id="threads-on-sunriseos" class="section-header"><a href="#threads-on-sunriseos">Threads on SunriseOS</a></h1>
<p>The sunrise kernel provides only three syscalls of interest relative to threads:</p>
<ul>
<li><a href="../../sunrise_libuser/syscalls/fn.create_thread.html"><code>svcCreateThread</code></a> : allocates kernel resources for a thread and returns a handle to it.</li>
<li><a href="../../sunrise_libuser/syscalls/fn.start_thread.html"><code>svcStartThread</code></a> : starts a thread created by <code>svcCreateThread</code>.</li>
<li><a href="../../sunrise_libuser/syscalls/fn.exit_thread.html"><code>svcExitThread</code></a> : terminates the current thread.</li>
</ul>
<p>Note that it is impossible to terminate another thread but our own.</p>
<p>The first thread of a process (referred later in this doc as &quot;main thread&quot;) gets the handle to
its own thread in one of its registers when it is started by the kernel.</p>
<h3 id="tls-region" class="section-header"><a href="#tls-region">TLS region</a></h3>
<p>Every thread possesses a small memory region called <a href="../../sunrise_libkern/struct.TLS.html">Thread Local Storage region</a> which the kernel
allocates, and puts its address in a ro register so it can be accessed from the userspace.</p>
<p>There lives the <a href="../../sunrise_libkern/type.IpcBuffer.html">IpcBuffer</a>, and a userspace controlled pointer where the user can store a
user-defined context. We use it to to keep a pointer to a <a href="../../sunrise_libuser/threads/struct.ThreadContext.html">ThreadContext</a> (see below).</p>
<h1 id="threads-in-libuser" class="section-header"><a href="#threads-in-libuser">Threads in libuser</a></h1>
<p>The main thread will always live for the entire life of the process.
When its routine returns, it calls <code>svcExitProcess</code> and every other thread will be killed.</p>
<p>It can create other threads, which are represented by the <a href="../../sunrise_libuser/threads/struct.Thread.html"><code>Thread</code></a> struct.
A <code>Thread</code> detaches (read &quot;leak&quot;) the associated thread when it is dropped,
which means that there is no longer any handle to thread and no way to join on it.</p>
<p>This is analog to the way the libstd threads work.</p>
<h3 id="thread-context" class="section-header"><a href="#thread-context">Thread context</a></h3>
<p>For every thread we create (and also for the main thread), we allocate a <a href="../../sunrise_libuser/threads/struct.ThreadContext.html">ThreadContext</a>
structure on the heap, which holds its stack, its thread handle so it will be able to use
mutexes, the routine we want it to execute, and the argument to pass to it.</p>
<h3 id="thread-entry-point" class="section-header"><a href="#thread-entry-point">Thread entry point</a></h3>
<p>We tell the kernel the entry of the thread is <a href="../../sunrise_libuser/threads/fn.thread_trampoline.html"><code>thread_trampoline</code></a>.
This function will set-up a valid environment for the routine (mainly handle ELF thread local variables),
call the routine with its argument, and finally call <code>svcExitThread</code> when the routine has returned.</p>
</div><h2 id='structs' class='section-header'><a href="#structs">Structs</a></h2>
<table><tr class='module-item'><td><a class="struct" href="struct.StackContext.html" title='sunrise_libuser::threads::StackContext struct'>StackContext</a></td><td class='docblock-short'><p>Stack allocation informations</p>
</td></tr><tr class='module-item'><td><a class="struct" href="struct.Thread.html" title='sunrise_libuser::threads::Thread struct'>Thread</a></td><td class='docblock-short'><p>Libuser's representation of a thread.</p>
</td></tr><tr class='module-item'><td><a class="struct" href="struct.ThreadContext.html" title='sunrise_libuser::threads::ThreadContext struct'>ThreadContext</a></td><td class='docblock-short'><p>Structure holding the thread local context of a thread.
Allocated at thread creation by the creator of the thread.</p>
</td></tr></table><h2 id='constants' class='section-header'><a href="#constants">Constants</a></h2>
<table><tr class='module-item'><td><a class="constant" href="constant.DEFAULT_STACK_SIZE.html" title='sunrise_libuser::threads::DEFAULT_STACK_SIZE constant'>DEFAULT_STACK_SIZE</a></td><td class='docblock-short'><p>Default size of a thread's stack, in bytes.</p>
</td></tr></table><h2 id='statics' class='section-header'><a href="#statics">Statics</a></h2>
<table><tr class='module-item'><td><a class="static" href="static.MAIN_THREAD_CONTEXT.html" title='sunrise_libuser::threads::MAIN_THREAD_CONTEXT static'>MAIN_THREAD_CONTEXT</a></td><td class='docblock-short'><p>Context of the main thread. Instead of allocating it at startup, this one lives in the <code>.data</code>.</p>
</td></tr></table><h2 id='functions' class='section-header'><a href="#functions">Functions</a></h2>
<table><tr class='module-item'><td><a class="fn" href="fn.get_my_ipc_buffer.html" title='sunrise_libuser::threads::get_my_ipc_buffer fn'>get_my_ipc_buffer</a></td><td class='docblock-short'><p>Get a pointer to this thread's <a href="../../sunrise_libkern/type.IpcBuffer.html">IPCBuffer</a>, from the <a href="../../sunrise_libkern/struct.TLS.html" title="TLS">TLS</a> region pointed to by <code>fs</code>.</p>
</td></tr><tr class='module-item'><td><a class="fn" href="fn.get_my_thread_context.html" title='sunrise_libuser::threads::get_my_thread_context fn'>get_my_thread_context</a></td><td class='docblock-short'><p>Get a reference to this thread's <a href="../../sunrise_libuser/threads/struct.ThreadContext.html" title="ThreadContext">ThreadContext</a>, from the <a href="../../sunrise_libkern/struct.TLS.html" title="TLS">TLS</a> region pointed to by <code>fs</code>.</p>
</td></tr><tr class='module-item'><td><a class="fn" href="fn.get_my_tls_region.html" title='sunrise_libuser::threads::get_my_tls_region fn'>get_my_tls_region</a></td><td class='docblock-short'><p>Get a pointer to this thread's <a href="../../sunrise_libkern/struct.TLS.html" title="TLS">TLS</a> region pointed to by <code>fs</code>, translated to the flat-memory model.</p>
</td></tr><tr class='module-item'><td><a class="fn" href="fn.init_main_thread.html" title='sunrise_libuser::threads::init_main_thread fn'>init_main_thread</a></td><td class='docblock-short'><p>Initialisation of the main thread's thread local structures:</p>
</td></tr><tr class='module-item'><td><a class="fn" href="fn.thread_trampoline.html" title='sunrise_libuser::threads::thread_trampoline fn'>thread_trampoline</a></td><td class='docblock-short'><p>Small stub executed by every thread but the main thread when they start.</p>
</td></tr></table></section><section id="search" class="content hidden"></section><section class="footer"></section><script>window.rootPath = "../../";window.currentCrate = "sunrise_libuser";</script><script src="../../main.js"></script><script defer src="../../search-index.js"></script></body></html>